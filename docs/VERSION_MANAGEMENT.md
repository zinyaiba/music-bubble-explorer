# バージョン管理とキャッシュ戦略

## 概要

このアプリケーションは、ユーザーに手動でキャッシュクリアを求めることなく、自動的に最新バージョンに更新できる仕組みを実装しています。

## 実装された機能

### 1. 自動バージョン検知

- `package.json`のバージョンを基準に、アプリケーション全体のバージョンを管理
- ビルド時に自動的に各ファイルのバージョン番号を同期
- ユーザーがアプリを開いたときに自動的にバージョンをチェック

### 2. 更新通知UI

- 新しいバージョンが検出されると、画面上部に通知を表示
- ユーザーは「今すぐ更新」または「後で」を選択可能
- 更新時は自動的にキャッシュをクリアしてリロード

### 3. Service Workerとの連携

- Service Workerのキャッシュ名にバージョン番号を含める
- 古いバージョンのキャッシュは自動的に削除
- バージョン情報をService Workerとクライアント間で共有

### 4. ファイル名のハッシュ化

- Viteのビルド設定により、すべてのアセットファイルにハッシュを付与
- ファイル内容が変更されると自動的に新しいハッシュが生成される
- ブラウザは自動的に新しいファイルを取得

## バージョンアップの手順

### 1. バージョン番号の更新

```bash
# package.jsonのversionを更新
npm version patch  # 0.0.1 -> 0.0.2
npm version minor  # 0.0.0 -> 0.1.0
npm version major  # 0.0.0 -> 1.0.0
```

### 2. ビルド

```bash
npm run build
```

ビルド時に自動的に以下が実行されます：
- `src/utils/versionManager.ts`のバージョン更新
- `public/sw.js`のバージョン更新

### 3. デプロイ

```bash
git push origin main
```

GitHub Actionsが自動的にビルドとデプロイを実行します。

## ユーザー体験

1. **初回訪問**: バージョン情報がLocalStorageに保存される
2. **通常使用**: 1時間ごとにバージョンチェックを実行
3. **更新検知**: 新しいバージョンが検出されると通知を表示
4. **更新適用**: ユーザーが「今すぐ更新」をクリックすると：
   - 古いキャッシュを削除
   - 新しいバージョン番号を保存
   - ページをリロード
   - 新しいService Workerがアクティブ化

## 技術詳細

### キャッシュ戦略

1. **HTML**: キャッシュしない（meta タグで制御）
2. **JS/CSS**: ファイル名にハッシュを含めるため、自動的に更新
3. **Service Worker**: バージョン番号を含むキャッシュ名を使用
4. **静的アセット**: Service Workerでキャッシュ、バージョン変更時に削除

### バージョンチェックのタイミング

- アプリ起動時
- 1時間ごと（自動）
- Service Workerの更新検知時

### データの保持

更新時も以下のデータは保持されます：
- 楽曲データ（`songs`）
- タグデータ（`tags`）
- ユーザーロール（`user_role`）
- ユーザー名（`user_name`）

## トラブルシューティング

### 更新が反映されない場合

開発者コンソールで以下を実行：

```javascript
// 強制的に最新バージョンに更新
import { forceUpdate } from './utils/versionManager';
forceUpdate();
```

### キャッシュを完全にクリアする場合

```javascript
// すべてのキャッシュをクリア
import { clearAllCaches } from './utils/versionManager';
clearAllCaches();
```

## 今後の拡張

- [ ] バックグラウンドでの自動更新
- [ ] 更新内容の表示（リリースノート）
- [ ] 段階的ロールアウト（A/Bテスト）
- [ ] オフライン時の更新キュー
