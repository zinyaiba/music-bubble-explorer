# Firebaseãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¬ã‚¤ãƒ‰

ã“ã®ã‚¬ã‚¤ãƒ‰ã§ã¯ã€Firestoreãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã¨å¾©å…ƒæ–¹æ³•ã«ã¤ã„ã¦èª¬æ˜ã—ã¾ã™ã€‚

## ğŸ“‹ ç›®æ¬¡

1. [äº‹å‰æº–å‚™](#äº‹å‰æº–å‚™)
2. [ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®å®Ÿè¡Œ](#ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®å®Ÿè¡Œ)
3. [ãƒ‡ãƒ¼ã‚¿ã®å¾©å…ƒ](#ãƒ‡ãƒ¼ã‚¿ã®å¾©å…ƒ)
4. [è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®è¨­å®š](#è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®è¨­å®š)
5. [ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°](#ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°)

## ğŸ”§ äº‹å‰æº–å‚™

### 1. Firebase Admin SDKã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```bash
npm install firebase-admin --save-dev
```

### 2. ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚­ãƒ¼ã®å–å¾—

1. [Firebase Console](https://console.firebase.google.com/)ã«ã‚¢ã‚¯ã‚»ã‚¹
2. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠ
3. âš™ï¸ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®š â†’ ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ
4. ã€Œæ–°ã—ã„ç§˜å¯†éµã®ç”Ÿæˆã€ã‚’ã‚¯ãƒªãƒƒã‚¯
5. ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸJSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä»¥ä¸‹ã®ã„ãšã‚Œã‹ã«é…ç½®ï¼š
   - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã« `firebase-service-account.json` ã¨ã—ã¦ä¿å­˜
   - ä»»æ„ã®å ´æ‰€ã«ä¿å­˜ã—ã€ç’°å¢ƒå¤‰æ•° `FIREBASE_SERVICE_ACCOUNT_KEY` ã«ãƒ‘ã‚¹ã‚’è¨­å®š

âš ï¸ **é‡è¦**: ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚­ãƒ¼ã¯æ©Ÿå¯†æƒ…å ±ã§ã™ã€‚Gitã«ã‚³ãƒŸãƒƒãƒˆã—ãªã„ã§ãã ã•ã„ï¼

### 3. .gitignoreã®ç¢ºèª

`.gitignore`ã«ä»¥ä¸‹ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªï¼š

```
firebase-service-account.json
backups/
```

## ğŸ’¾ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®å®Ÿè¡Œ

### åŸºæœ¬çš„ãªä½¿ã„æ–¹

```bash
# npm scriptã‚’ä½¿ç”¨ï¼ˆæ¨å¥¨ï¼‰
npm run backup

# ã¾ãŸã¯ç›´æ¥å®Ÿè¡Œ
node scripts/firebase-backup.cjs
```

ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã¯ `backups/firebase-backup-YYYY-MM-DDTHH-MM-SS.json` ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚

### ã‚«ã‚¹ã‚¿ãƒ å‡ºåŠ›å…ˆã‚’æŒ‡å®š

```bash
node scripts/firebase-backup.cjs --output my-backup.json
```

### ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®å†…å®¹

ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã«ã¯ä»¥ä¸‹ã®æƒ…å ±ãŒå«ã¾ã‚Œã¾ã™ï¼š

```json
{
  "timestamp": "2024-11-29T12:00:00.000Z",
  "version": "1.0.0",
  "collections": {
    "songs": [
      {
        "id": "song-id-123",
        "data": {
          "title": "æ¥½æ›²ã‚¿ã‚¤ãƒˆãƒ«",
          "artists": ["ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆå"],
          "lyricists": ["ä½œè©è€…"],
          "composers": ["ä½œæ›²è€…"],
          "arrangers": ["ç·¨æ›²è€…"],
          "tags": ["ã‚¿ã‚°1", "ã‚¿ã‚°2"],
          "createdAt": "2024-11-29T12:00:00.000Z"
        }
      }
    ]
  }
}
```

## ğŸ”„ ãƒ‡ãƒ¼ã‚¿ã®å¾©å…ƒ

### åŸºæœ¬çš„ãªä½¿ã„æ–¹

```bash
# æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¦å¾©å…ƒï¼ˆå®Œå…¨ãƒªã‚¹ãƒˆã‚¢ï¼‰
npm run restore backups/firebase-backup-2024-11-29.json

# ã¾ãŸã¯ç›´æ¥å®Ÿè¡Œ
node scripts/firebase-restore.cjs backups/firebase-backup-2024-11-29.json
```

âš ï¸ **è­¦å‘Š**: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¦ã‹ã‚‰å¾©å…ƒã—ã¾ã™ã€‚

### ãƒãƒ¼ã‚¸ãƒ¢ãƒ¼ãƒ‰

æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒã—ãŸã¾ã¾å¾©å…ƒã™ã‚‹å ´åˆï¼š

```bash
node scripts/firebase-restore.cjs backups/firebase-backup-2024-11-29.json --merge
```

ãƒãƒ¼ã‚¸ãƒ¢ãƒ¼ãƒ‰ã§ã¯ï¼š
- åŒã˜IDã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™
- æ—¢å­˜ã®ä»–ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ä¿æŒã•ã‚Œã¾ã™

## â° è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®è¨­å®š

### æ–¹æ³•1: cronã‚¸ãƒ§ãƒ–ï¼ˆLinux/Macï¼‰

```bash
# crontabã‚’ç·¨é›†
crontab -e

# æ¯æ—¥åˆå‰3æ™‚ã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å®Ÿè¡Œ
0 3 * * * cd /path/to/project && npm run backup
```

### æ–¹æ³•2: Windows ã‚¿ã‚¹ã‚¯ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©

1. ã‚¿ã‚¹ã‚¯ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ã‚’é–‹ã
2. ã€ŒåŸºæœ¬ã‚¿ã‚¹ã‚¯ã®ä½œæˆã€ã‚’é¸æŠ
3. ãƒˆãƒªã‚¬ãƒ¼: æ¯æ—¥
4. æ“ä½œ: ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®é–‹å§‹
   - ãƒ—ãƒ­ã‚°ãƒ©ãƒ : `cmd.exe`
   - å¼•æ•°: `/c cd /d "C:\path\to\project" && npm run backup`

### æ–¹æ³•3: GitHub Actions

`.github/workflows/backup.yml` ã‚’ä½œæˆï¼š

```yaml
name: Firebase Backup

on:
  schedule:
    # æ¯æ—¥åˆå‰3æ™‚ï¼ˆUTCï¼‰ã«å®Ÿè¡Œ
    - cron: '0 3 * * *'
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

jobs:
  backup:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Create service account file
        run: echo '${{ secrets.FIREBASE_SERVICE_ACCOUNT }}' > firebase-service-account.json
      
      - name: Run backup
        run: npm run backup
      
      - name: Upload backup
        uses: actions/upload-artifact@v3
        with:
          name: firebase-backup
          path: backups/
          retention-days: 30
```

GitHub Secretsã« `FIREBASE_SERVICE_ACCOUNT` ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚

## ğŸ” ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ã‚¨ãƒ©ãƒ¼: ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚­ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“

**åŸå› **: `firebase-service-account.json` ãŒæ­£ã—ã„å ´æ‰€ã«ãªã„

**è§£æ±ºæ–¹æ³•**:
1. ãƒ•ã‚¡ã‚¤ãƒ«ãŒãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã«ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª
2. ã¾ãŸã¯ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šï¼š
   ```bash
   export FIREBASE_SERVICE_ACCOUNT_KEY=/path/to/service-account.json
   ```

### ã‚¨ãƒ©ãƒ¼: Permission denied

**åŸå› **: ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«å¿…è¦ãªæ¨©é™ãŒãªã„

**è§£æ±ºæ–¹æ³•**:
1. Firebase Console â†’ IAM ã¨ç®¡ç†
2. ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ã€ŒCloud Datastore ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€ãƒ­ãƒ¼ãƒ«ã‚’ä»˜ä¸

### ã‚¨ãƒ©ãƒ¼: Module not found: firebase-admin

**åŸå› **: firebase-adminãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ãªã„

**è§£æ±ºæ–¹æ³•**:
```bash
npm install firebase-admin --save-dev
```

### ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤§ãã™ãã‚‹

**å¯¾å‡¦æ–¹æ³•**:
1. åœ§ç¸®ã—ã¦ä¿å­˜ï¼š
   ```bash
   node scripts/firebase-backup.cjs
   gzip backups/firebase-backup-*.json
   ```

2. å¤ã„ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å‰Šé™¤ï¼š
   ```bash
   # 30æ—¥ä»¥ä¸Šå‰ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å‰Šé™¤ï¼ˆLinux/Macï¼‰
   find backups/ -name "*.json" -mtime +30 -delete
   ```

## ğŸ“Š ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

1. **å®šæœŸçš„ãªãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—**: æœ€ä½ã§ã‚‚é€±1å›ã€ã§ãã‚Œã°æ¯æ—¥
2. **è¤‡æ•°ã®ä¿å­˜å…ˆ**: ãƒ­ãƒ¼ã‚«ãƒ« + ã‚¯ãƒ©ã‚¦ãƒ‰ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ï¼ˆGoogle Driveã€S3ãªã©ï¼‰
3. **ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®ãƒ†ã‚¹ãƒˆ**: å®šæœŸçš„ã«å¾©å…ƒãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
4. **ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†**: è¤‡æ•°ä¸–ä»£ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä¿æŒ
5. **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**: ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã‚‚æš—å·åŒ–ã‚’æ¤œè¨

## ğŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã«é–¢ã™ã‚‹æ³¨æ„

- ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚­ãƒ¼ã¯çµ¶å¯¾ã«Gitã«ã‚³ãƒŸãƒƒãƒˆã—ãªã„
- ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã«ã¯å€‹äººæƒ…å ±ãŒå«ã¾ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ã€é©åˆ‡ã«ç®¡ç†
- ä¸è¦ã«ãªã£ãŸãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã¯ç¢ºå®Ÿã«å‰Šé™¤
- ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚’æœ€å°é™ã«è¨­å®š

## ğŸ“š é–¢é€£ãƒªãƒ³ã‚¯

- [Firebase Admin SDK ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://firebase.google.com/docs/admin/setup)
- [Firestore ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã¨ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ](https://firebase.google.com/docs/firestore/manage-data/export-import)
- [Firebase ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«](https://firebase.google.com/docs/firestore/security/get-started)
